<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Providence Sacred Heart Medical Center — Outreach Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #002B5C 0%, #1a4d8a 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            z-index: 100;
        }

        .header-left {
            flex: 1;
            min-width: 300px;
        }

        .header-title {
            font-family: 'Poppins', sans-serif;
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 4px 0;
            color: #ffffff;
        }

        .header-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin: 0;
        }

        .header-branding {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            opacity: 0.85;
            white-space: nowrap;
        }

        .jnj-badge {
            background: rgba(235, 23, 0, 0.2);
            border: 1px solid #EB1700;
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: 600;
            color: #FFB3A7;
        }

        .header-right {
            font-size: 12px;
            opacity: 0.9;
            white-space: nowrap;
        }

        /* Main Container */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            z-index: 50;
        }

        .sidebar-toggle {
            display: none;
            position: absolute;
            left: 12px;
            top: 100px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            z-index: 60;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-toggle:hover {
            background: #f3f4f6;
        }

        /* Stats Card */
        .stats-card {
            background: linear-gradient(135deg, #0077C8 0%, #0056a0 100%);
            border-radius: 8px;
            padding: 16px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0, 119, 200, 0.15);
        }

        .stats-card h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            opacity: 0.95;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .stat-value {
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        /* Legend */
        .legend-section {
            margin-bottom: 24px;
        }

        .legend-title {
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #1f2937;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            margin-bottom: 10px;
            padding: 6px 0;
        }

        .legend-marker {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .legend-marker.sacred-heart {
            background: #EB1700;
            box-shadow: 0 0 0 2px rgba(235, 23, 0, 0.2);
        }

        .legend-marker.csc {
            background: #9333ea;
        }

        .legend-marker.tsc {
            background: #0077C8;
        }

        .legend-marker.psc {
            background: #10b981;
        }

        .legend-marker.spoke {
            background: #f97316;
        }

        .legend-marker.cah {
            border: 2px solid #ef4444;
            background: transparent;
        }

        .legend-marker.tribal {
            background: #06b6d4;
        }

        .legend-marker.lifeflight {
            background: #f59e0b;
        }

        .legend-line {
            height: 2px;
            flex: 1;
            border-radius: 1px;
        }

        .legend-line.ems {
            background: #3B82F6;
        }

        .legend-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .legend-circle.radius-100 {
            border: 2px solid #3B82F6;
            background: rgba(59, 130, 246, 0.1);
        }

        .legend-circle.radius-200 {
            border: 2px dashed #93c5fd;
            background: transparent;
        }

        .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 2px;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        /* Choropleth Legend Section */
        .choropleth-legend-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }

        .choropleth-legend-title {
            font-family: 'Poppins', sans-serif;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #1f2937;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .choropleth-tier {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            margin-bottom: 6px;
        }

        .choropleth-tier:last-child {
            margin-bottom: 0;
        }

        .choropleth-note {
            font-size: 10px;
            color: #6b7280;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #d1d5db;
            font-style: italic;
        }

        /* Facility Lists */
        .facility-list {
            margin-top: 20px;
        }

        .facility-zone {
            margin-bottom: 16px;
        }

        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .zone-header:hover {
            background: #e5e7eb;
        }

        .zone-header-title {
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: #1f2937;
        }

        .zone-count {
            font-size: 11px;
            background: #d1d5db;
            color: #374151;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .zone-toggle {
            margin-left: 8px;
            transition: transform 0.2s ease;
        }

        .zone-toggle.open {
            transform: rotate(180deg);
        }

        .zone-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .zone-content.open {
            max-height: 800px;
        }

        .facility-item {
            padding: 10px 12px;
            border-left: 3px solid #dbeafe;
            margin-top: 8px;
            background: #f9fafb;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 11px;
        }

        .facility-item:hover {
            background: #f0f9ff;
            border-left-color: #0077C8;
        }

        .facility-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .facility-meta {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #6b7280;
        }

        .facility-badge {
            display: inline-block;
            background: #dbeafe;
            color: #0077C8;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
            font-size: 9px;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: #e5e7eb;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Leaflet Overrides */
        .leaflet-popup-content {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            line-height: 1.4;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .popup-title {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .popup-info {
            color: #4b5563;
            margin: 4px 0;
            font-size: 11px;
        }

        .popup-badge {
            display: inline-block;
            background: #EB1700;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 4px;
        }

        /* County Popup Card */
        .county-popup-card {
            background: white;
            border-radius: 8px;
            padding: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            min-width: 280px;
        }

        .county-card-header {
            font-weight: 700;
            color: #1f2937;
            font-size: 13px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .county-card-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 11px;
            color: #4b5563;
        }

        .county-card-label {
            font-weight: 500;
            color: #374151;
        }

        .county-card-value {
            font-weight: 600;
            color: #1f2937;
        }

        .county-risk-badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
            color: white;
            margin-top: 10px;
            width: 100%;
            text-align: center;
        }

        /* Choropleth Toggle Button */
        .leaflet-control-choropleth {
            background: white;
            border: 2px solid #EB1700;
            border-radius: 6px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .choropleth-toggle-btn {
            background: white;
            border: none;
            padding: 10px 14px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: #1f2937;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .choropleth-toggle-btn:hover {
            background: #EB1700;
            color: white;
        }

        .choropleth-toggle-btn.active {
            background: #EB1700;
            color: white;
        }

        .choropleth-toggle-indicator {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background: #d1d5db;
            display: inline-block;
        }

        .choropleth-toggle-btn.active .choropleth-toggle-indicator {
            background: #FFB3A7;
        }

        /* Floating Choropleth Legend */
        .choropleth-map-legend {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            z-index: 40;
        }

        .choropleth-map-legend-title {
            font-family: 'Poppins', sans-serif;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
            color: #1f2937;
            letter-spacing: 0.5px;
        }

        .choropleth-map-legend-tier {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 10px;
        }

        .choropleth-map-legend-tier:last-child {
            margin-bottom: 0;
        }

        .choropleth-map-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            border: 1px solid rgba(0, 0, 0, 0.15);
        }

        /* Footer */
        .footer {
            background: #1f2937;
            color: #e5e7eb;
            padding: 12px 24px;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-top: 1px solid #374151;
        }

        .footer-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-left {
            flex: 1;
        }

        .footer-right {
            text-align: right;
            opacity: 0.8;
        }

        .footer-sources {
            font-size: 10px;
            opacity: 0.75;
            line-height: 1.4;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }

            .header-title {
                font-size: 18px;
            }

            .header-subtitle {
                font-size: 12px;
            }

            .header-right {
                display: none;
            }

            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                position: relative;
            }

            .sidebar.collapsed {
                max-height: 50px;
            }

            .sidebar-toggle {
                display: block;
            }

            .sidebar-content {
                display: none;
            }

            .sidebar.open .sidebar-content {
                display: block;
            }

            #map {
                min-height: 300px;
            }

            .footer {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .footer-line {
                flex-direction: column;
                gap: 4px;
            }

            .footer-left, .footer-right {
                flex: auto;
            }
        }

        /* Print Styles */
        @media print {
            .header, .footer, .sidebar-toggle {
                display: none;
            }

            .container {
                height: auto;
            }

            .sidebar {
                display: none;
            }

            .map-container {
                height: 600px;
            }

            body {
                background: white;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(235, 23, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(235, 23, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(235, 23, 0, 0);
            }
        }

        .sacred-heart-pulse {
            animation: pulse 2s infinite;
        }

        /* Scrollbar Styling */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1 class="header-title">Providence Sacred Heart Medical Center — Outreach Map</h1>
            <p class="header-subtitle">Spokane, WA | CSC | 100 & 200 Mile Service Radii</p>
        </div>
        <div class="header-branding">
            <span class="jnj-badge">J&J MedTech</span>
            <span>Cerenovus</span>
        </div>
        <div class="header-right">Prepared for Dr. Yiping Li</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebarToggle">☰</button>

            <div class="sidebar-content">
                <!-- Stats Card -->
                <div class="stats-card">
                    <h3>SERVICE AREA SUMMARY</h3>
                    <div class="stat-row">
                        <span>0–100 miles:</span>
                        <span class="stat-value" id="stat-zone1">–</span>
                    </div>
                    <div class="stat-row">
                        <span>100–200 miles:</span>
                        <span class="stat-value" id="stat-zone2">–</span>
                    </div>
                    <div class="stat-row">
                        <span>Total in radius:</span>
                        <span class="stat-value" id="stat-total">–</span>
                    </div>
                </div>

                <!-- Legend -->
                <div class="legend-section">
                    <div class="legend-title">Legend</div>

                    <div class="legend-item">
                        <div class="legend-marker sacred-heart"></div>
                        <span>Sacred Heart Hub</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker csc"></div>
                        <span>Comprehensive Stroke Center</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker tsc"></div>
                        <span>Thrombectomy-Capable Center</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker psc"></div>
                        <span>Primary Stroke Center</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker spoke"></div>
                        <span>Spoke Referral Hospital</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker cah"></div>
                        <span>Critical Access Hospital</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker tribal"></div>
                        <span>Tribal Health Facility</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker lifeflight"></div>
                        <span>Life Flight Base</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-line ems"></div>
                        <span>EMS Route</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-circle radius-100"></div>
                        <span>100-mile radius</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-circle radius-200"></div>
                        <span>200-mile radius</span>
                    </div>

                    <!-- Choropleth Legend Section -->
                    <div class="choropleth-legend-section">
                        <div class="choropleth-legend-title">Stroke Mortality</div>
                        <div class="legend-item">
                            <div class="legend-swatch" style="background: #EB1700;"></div>
                            <span>Very High (&gt;120/100K)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-swatch" style="background: #F97316;"></div>
                            <span>High (80–120/100K)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-swatch" style="background: #0077C8;"></div>
                            <span>Moderate (60–80/100K)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-swatch" style="background: #002B5C;"></div>
                            <span>Low (&lt;60/100K)</span>
                        </div>
                        <div class="choropleth-note">CDC WONDER 2018–2023 | ICD-10 I60–I69</div>
                    </div>
                </div>

                <!-- Facility Lists -->
                <div class="facility-list" id="facilityList"></div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-line">
            <div class="footer-left">
                <strong>Cerenovus</strong> | J&J MedTech Neurovascular | PNW Territory
            </div>
            <div class="footer-right">
                Generated <span id="generatedDate"></span> | For internal use only
            </div>
        </div>
        <div class="footer-sources">
            <strong>Sources:</strong> CDC WONDER (stroke mortality 2018–2023) | US Census ACS (population, median age) | WA DOH CHARS (hospital data) | State EMS directories | Flex Monitoring Team (CAH data) | IHS (tribal facilities)
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ===== COUNTY DATA WITH SIMPLIFIED POLYGONS =====

        const countyData = [
            // WASHINGTON - Eastern
            { name: "Spokane", state: "WA", pop: 539339, strokeDeaths: 312, strokeDeathRate: 57.9, avgAge: 37.2, distMiles: 0, ems: "Spokane Co. EMS / AMR", bounds: [[47.4, -118.0], [48.0, -118.0], [48.0, -117.0], [47.4, -117.0]] },
            { name: "Lincoln", state: "WA", pop: 10987, strokeDeaths: 14, strokeDeathRate: 127.4, avgAge: 45.8, distMiles: 38, ems: "Lincoln Co. Fire/EMS", bounds: [[47.4, -118.9], [47.9, -118.9], [47.9, -117.9], [47.4, -117.9]] },
            { name: "Stevens", state: "WA", pop: 46345, strokeDeaths: 42, strokeDeathRate: 90.6, avgAge: 42.3, distMiles: 55, ems: "Stevens Co. EMS / LifeFlight", bounds: [[47.8, -118.2], [48.9, -118.2], [48.9, -117.2], [47.8, -117.2]] },
            { name: "Pend Oreille", state: "WA", pop: 13724, strokeDeaths: 16, strokeDeathRate: 116.6, avgAge: 46.1, distMiles: 60, ems: "Pend Oreille Co. Fire/EMS", bounds: [[48.0, -117.5], [49.0, -117.5], [49.0, -117.0], [48.0, -117.0]] },
            { name: "Whitman", state: "WA", pop: 50804, strokeDeaths: 22, strokeDeathRate: 43.3, avgAge: 24.8, distMiles: 65, ems: "Whitman Co. Ambulance / WSU EMS", bounds: [[46.4, -118.0], [47.3, -118.0], [47.3, -117.0], [46.4, -117.0]] },
            { name: "Adams", state: "WA", pop: 20668, strokeDeaths: 18, strokeDeathRate: 87.1, avgAge: 30.2, distMiles: 85, ems: "Adams Co. Ambulance", bounds: [[46.6, -119.2], [47.2, -119.2], [47.2, -118.2], [46.6, -118.2]] },
            { name: "Ferry", state: "WA", pop: 7966, strokeDeaths: 10, strokeDeathRate: 125.6, avgAge: 47.3, distMiles: 80, ems: "Ferry Co. EMS / LifeFlight", bounds: [[48.0, -119.0], [49.0, -119.0], [49.0, -118.0], [48.0, -118.0]] },
            { name: "Grant", state: "WA", pop: 99123, strokeDeaths: 76, strokeDeathRate: 76.7, avgAge: 33.1, distMiles: 110, ems: "Grant Co. Fire #5 / AMR", bounds: [[46.7, -120.0], [47.6, -120.0], [47.6, -119.0], [46.7, -119.0]] },
            { name: "Okanogan", state: "WA", pop: 42243, strokeDeaths: 48, strokeDeathRate: 113.6, avgAge: 42.6, distMiles: 120, ems: "Okanogan Co. Ambulance / LifeFlight", bounds: [[47.8, -120.8], [49.0, -120.8], [49.0, -119.4], [47.8, -119.4]] },
            { name: "Douglas", state: "WA", pop: 43429, strokeDeaths: 32, strokeDeathRate: 73.7, avgAge: 35.2, distMiles: 130, ems: "Douglas Co. Fire / LifeFlight", bounds: [[47.2, -120.7], [47.9, -120.7], [47.9, -119.7], [47.2, -119.7]] },
            { name: "Chelan", state: "WA", pop: 80492, strokeDeaths: 56, strokeDeathRate: 69.6, avgAge: 38.4, distMiles: 140, ems: "Chelan Co. Fire / LifeFlight", bounds: [[47.3, -121.2], [48.2, -121.2], [48.2, -120.1], [47.3, -120.1]] },
            { name: "Walla Walla", state: "WA", pop: 62584, strokeDeaths: 52, strokeDeathRate: 83.1, avgAge: 37.6, distMiles: 150, ems: "Walla Walla Fire / AMR", bounds: [[45.9, -119.0], [46.4, -119.0], [46.4, -118.0], [45.9, -118.0]] },
            { name: "Columbia", state: "WA", pop: 4064, strokeDeaths: 6, strokeDeathRate: 147.6, avgAge: 49.2, distMiles: 130, ems: "Columbia Co. Ambulance", bounds: [[46.0, -118.2], [46.4, -118.2], [46.4, -117.7], [46.0, -117.7]] },
            { name: "Garfield", state: "WA", pop: 2247, strokeDeaths: 4, strokeDeathRate: 178.0, avgAge: 50.1, distMiles: 100, ems: "Garfield Co. Ambulance", bounds: [[46.0, -117.7], [46.5, -117.7], [46.5, -117.3], [46.0, -117.3]] },
            { name: "Asotin", state: "WA", pop: 22582, strokeDeaths: 24, strokeDeathRate: 106.3, avgAge: 42.8, distMiles: 105, ems: "Asotin Co. Fire / AMR", bounds: [[45.9, -117.5], [46.4, -117.5], [46.4, -117.0], [45.9, -117.0]] },
            { name: "Franklin", state: "WA", pop: 95222, strokeDeaths: 48, strokeDeathRate: 50.4, avgAge: 28.8, distMiles: 140, ems: "Pasco Fire / AMR", bounds: [[46.0, -119.5], [46.7, -119.5], [46.7, -118.8], [46.0, -118.8]] },
            { name: "Benton", state: "WA", pop: 204390, strokeDeaths: 126, strokeDeathRate: 61.6, avgAge: 35.6, distMiles: 145, ems: "Richland Fire / AMR / LifeFlight", bounds: [[45.9, -120.0], [46.6, -120.0], [46.6, -119.1], [45.9, -119.1]] },
            // IDAHO - Northern
            { name: "Kootenai", state: "ID", pop: 171003, strokeDeaths: 108, strokeDeathRate: 63.2, avgAge: 38.5, distMiles: 35, ems: "Kootenai Co. Fire/EMS / AMR", bounds: [[47.3, -117.0], [47.9, -117.0], [47.9, -116.3], [47.3, -116.3]] },
            { name: "Bonner", state: "ID", pop: 47110, strokeDeaths: 38, strokeDeathRate: 80.7, avgAge: 43.2, distMiles: 80, ems: "Bonner Co. EMS / LifeFlight", bounds: [[47.9, -117.0], [48.8, -117.0], [48.8, -116.0], [47.9, -116.0]] },
            { name: "Boundary", state: "ID", pop: 12783, strokeDeaths: 14, strokeDeathRate: 109.5, avgAge: 44.8, distMiles: 95, ems: "Boundary Co. Ambulance", bounds: [[48.7, -116.8], [49.0, -116.8], [49.0, -116.0], [48.7, -116.0]] },
            { name: "Shoshone", state: "ID", pop: 13177, strokeDeaths: 16, strokeDeathRate: 121.4, avgAge: 44.1, distMiles: 70, ems: "Shoshone Co. Ambulance / LifeFlight", bounds: [[47.2, -116.3], [47.6, -116.3], [47.6, -115.5], [47.2, -115.5]] },
            { name: "Benewah", state: "ID", pop: 9511, strokeDeaths: 12, strokeDeathRate: 126.2, avgAge: 43.6, distMiles: 50, ems: "Benewah Co. Ambulance", bounds: [[46.9, -117.0], [47.4, -117.0], [47.4, -116.4], [46.9, -116.4]] },
            { name: "Latah", state: "ID", pop: 40862, strokeDeaths: 16, strokeDeathRate: 39.2, avgAge: 25.6, distMiles: 80, ems: "Moscow VFD / Gritman Ambulance", bounds: [[46.4, -117.2], [47.0, -117.2], [47.0, -116.4], [46.4, -116.4]] },
            { name: "Nez Perce", state: "ID", pop: 41880, strokeDeaths: 38, strokeDeathRate: 90.7, avgAge: 39.8, distMiles: 100, ems: "Lewiston Fire / AMR", bounds: [[46.0, -117.2], [46.5, -117.2], [46.5, -116.5], [46.0, -116.5]] },
            { name: "Clearwater", state: "ID", pop: 9080, strokeDeaths: 12, strokeDeathRate: 132.2, avgAge: 47.2, distMiles: 95, ems: "Clearwater Co. Ambulance", bounds: [[46.3, -116.5], [46.9, -116.5], [46.9, -115.6], [46.3, -115.6]] },
            { name: "Idaho", state: "ID", pop: 17198, strokeDeaths: 20, strokeDeathRate: 116.3, avgAge: 45.3, distMiles: 120, ems: "Idaho Co. Ambulance / LifeFlight", bounds: [[45.0, -116.5], [46.3, -116.5], [46.3, -114.5], [45.0, -114.5]] },
            { name: "Lewis", state: "ID", pop: 3972, strokeDeaths: 6, strokeDeathRate: 151.1, avgAge: 44.6, distMiles: 110, ems: "Lewis Co. Ambulance", bounds: [[46.0, -116.7], [46.3, -116.7], [46.3, -116.2], [46.0, -116.2]] },
            // MONTANA - Western
            { name: "Mineral", state: "MT", pop: 4397, strokeDeaths: 6, strokeDeathRate: 136.5, avgAge: 49.8, distMiles: 130, ems: "Mineral Co. Ambulance", bounds: [[46.7, -116.1], [47.2, -116.1], [47.2, -115.0], [46.7, -115.0]] },
            { name: "Sanders", state: "MT", pop: 12281, strokeDeaths: 16, strokeDeathRate: 130.3, avgAge: 50.2, distMiles: 150, ems: "Sanders Co. Ambulance / LifeFlight", bounds: [[47.2, -116.1], [48.0, -116.1], [48.0, -114.7], [47.2, -114.7]] },
            { name: "Lincoln", state: "MT", pop: 19839, strokeDeaths: 22, strokeDeathRate: 110.9, avgAge: 47.6, distMiles: 140, ems: "Lincoln Co. Ambulance / LifeFlight", bounds: [[47.9, -116.1], [49.0, -116.1], [49.0, -115.0], [47.9, -115.0]] },
            { name: "Missoula", state: "MT", pop: 119600, strokeDeaths: 62, strokeDeathRate: 51.8, avgAge: 33.4, distMiles: 200, ems: "Missoula Fire / AMR / LifeFlight", bounds: [[46.6, -114.8], [47.4, -114.8], [47.4, -113.2], [46.6, -113.2]] },
            { name: "Ravalli", state: "MT", pop: 44174, strokeDeaths: 44, strokeDeathRate: 99.6, avgAge: 46.3, distMiles: 195, ems: "Ravalli Co. Ambulance / LifeFlight", bounds: [[45.8, -114.7], [46.7, -114.7], [46.7, -113.7], [45.8, -113.7]] },
            { name: "Lake", state: "MT", pop: 31008, strokeDeaths: 28, strokeDeathRate: 90.3, avgAge: 41.8, distMiles: 175, ems: "Lake Co. Ambulance / LifeFlight", bounds: [[47.2, -114.7], [47.9, -114.7], [47.9, -113.6], [47.2, -113.6]] },
            { name: "Flathead", state: "MT", pop: 104357, strokeDeaths: 72, strokeDeathRate: 69.0, avgAge: 40.1, distMiles: 180, ems: "Flathead Co. Ambulance / ALERT / LifeFlight", bounds: [[47.7, -114.9], [49.0, -114.9], [49.0, -113.5], [47.7, -113.5]] },
        ];

        // ===== EMBEDDED DATA =====

        const sacredHeart = {
            name: "PROVIDENCE SACRED HEART MEDICAL CENTER",
            city: "Spokane",
            state: "WA",
            lat: 47.6588,
            lng: -117.4260,
            certification: "CSC",
            hubId: 13
        };

        const hospitals = [
            { name: "PROVIDENCE SACRED HEART MEDICAL CENTER", city: "Spokane", state: "WA", lat: 47.6588, lng: -117.4260, certification: "CSC" },
            { name: "MULTICARE DEACONESS HOSPITAL", city: "Spokane", state: "WA", lat: 47.6401, lng: -117.4101, certification: "PSC" },
            { name: "KOOTENAI HEALTH", city: "Coeur d'Alene", state: "ID", lat: 47.6901, lng: -116.7801, certification: "TSC" },
            { name: "PROVIDENCE ST PATRICK HOSPITAL", city: "Missoula", state: "MT", lat: 46.8721, lng: -114.0135, certification: "TSC" },
            { name: "COMMUNITY MEDICAL CENTER", city: "Missoula", state: "MT", lat: 46.8722, lng: -114.0056, certification: "PSC" },
            { name: "ST JOSEPHS REGIONAL MEDICAL CENTER", city: "Lewiston", state: "ID", lat: 46.4189, lng: -117.0178, certification: "PSC" },
            { name: "KADLEC REGIONAL MEDICAL CENTER", city: "Richland", state: "WA", lat: 46.2856, lng: -119.2845, certification: "TSC" },
            { name: "CENTRAL WASHINGTON HOSPITAL", city: "Wenatchee", state: "WA", lat: 47.4235, lng: -120.3103, certification: "PSC" },
            { name: "YAKIMA VALLEY MEMORIAL HOSPITAL", city: "Yakima", state: "WA", lat: 46.6021, lng: -120.5059, certification: "PSC" },
            { name: "PEACEHEALTH ST JOSEPH MEDICAL CENTER", city: "Bellingham", state: "WA", lat: 48.7519, lng: -122.4787, certification: "TSC" },
            { name: "PROVIDENCE ST MARY MEDICAL CENTER", city: "Walla Walla", state: "WA", lat: 46.0646, lng: -118.3430, certification: "PSC" },
            { name: "LOGAN HEALTH", city: "Kalispell", state: "MT", lat: 48.1920, lng: -114.3168, certification: "TSC" },
            { name: "BENEFIS HEALTH SYSTEM", city: "Great Falls", state: "MT", lat: 47.5053, lng: -111.3008, certification: "TSC" },
            { name: "EASTERN IDAHO REGIONAL MEDICAL CENTER", city: "Idaho Falls", state: "ID", lat: 43.4895, lng: -112.0339, certification: "TSC" },
            { name: "BOZEMAN HEALTH DEACONESS HOSPITAL", city: "Bozeman", state: "MT", lat: 45.6803, lng: -111.0367, certification: "TSC" },
            { name: "ST LUKES BOISE MEDICAL CENTER", city: "Boise", state: "ID", lat: 43.6018, lng: -116.2054, certification: "CSC" },
            { name: "SAINT ALPHONSUS REGIONAL MEDICAL CENTER", city: "Boise", state: "ID", lat: 43.6186, lng: -116.2247, certification: "CSC" },
            { name: "ST PETERS HEALTH", city: "Helena", state: "MT", lat: 46.5927, lng: -112.0361, certification: "PSC" },
            { name: "BILLINGS CLINIC", city: "Billings", state: "MT", lat: 45.7849, lng: -108.5039, certification: "CSC" },
            { name: "PORTNEUF MEDICAL CENTER", city: "Pocatello", state: "ID", lat: 42.8713, lng: -112.4455, certification: "PSC" },
            { name: "ST LUKES MERIDIAN MEDICAL CENTER", city: "Meridian", state: "ID", lat: 43.6008, lng: -116.3915, certification: "TSC" },
            { name: "ST JAMES HEALTHCARE", city: "Butte", state: "MT", lat: 46.0038, lng: -112.5348, certification: "PSC" },
            { name: "ST LUKES MAGIC VALLEY", city: "Twin Falls", state: "ID", lat: 42.5558, lng: -114.4701, certification: "PSC" },
            { name: "SAINT VINCENT HEALTHCARE", city: "Billings", state: "MT", lat: 45.7801, lng: -108.5101, certification: "PSC" },
            { name: "WEST VALLEY MEDICAL CENTER", city: "Caldwell", state: "ID", lat: 43.6629, lng: -116.6874, certification: "PSC" },
        ];

        const spokeHospitals = [
            { name: "Pullman Regional", city: "Pullman", state: "WA", lat: 46.7324, lng: -117.1817, annualTransfers: 18, avgTransferTime: 85, strokeCenter: "ASRH", beds: 25 },
            { name: "Gritman Medical", city: "Moscow", state: "ID", lat: 46.7324, lng: -117.0028, annualTransfers: 14, avgTransferTime: 90, strokeCenter: "PSC", beds: 25 },
        ];

        const emsRoutes = [
            { name: "US-2 West", from: "Wenatchee", to: "Sacred Heart", color: "#3B82F6", coords: [[47.4235, -120.3103], [47.6588, -117.4260]], avgTime: 180, type: "ground" },
            { name: "I-90 East", from: "Moses Lake", to: "Sacred Heart", color: "#3B82F6", coords: [[47.1301, -119.2781], [47.6588, -117.4260]], avgTime: 120, type: "ground" },
        ];

        const criticalAccessHospitals = [
            { name: "Columbia Basin Hospital", city: "Ephrata", state: "WA", lat: 47.3176, lng: -119.5536, beds: 25 },
            { name: "Coulee Medical Center", city: "Grand Coulee", state: "WA", lat: 47.9418, lng: -119.0033, beds: 25 },
            { name: "Dayton General Hospital", city: "Dayton", state: "WA", lat: 46.3237, lng: -117.9726, beds: 25 },
            { name: "Garfield County Hospital", city: "Pomeroy", state: "WA", lat: 46.4713, lng: -117.6008, beds: 25 },
            { name: "Kittitas Valley Healthcare", city: "Ellensburg", state: "WA", lat: 46.9965, lng: -120.5478, beds: 25 },
            { name: "Lake Chelan Community Hospital", city: "Chelan", state: "WA", lat: 47.8407, lng: -120.0161, beds: 25 },
            { name: "Lincoln Hospital", city: "Davenport", state: "WA", lat: 47.6540, lng: -118.1498, beds: 25 },
            { name: "Mid-Valley Hospital", city: "Omak", state: "WA", lat: 48.4107, lng: -119.5276, beds: 30 },
            { name: "Newport Hospital", city: "Newport", state: "WA", lat: 48.1851, lng: -117.0428, beds: 24 },
            { name: "North Valley Hospital", city: "Tonasket", state: "WA", lat: 48.7054, lng: -119.4389, beds: 25 },
            { name: "Odessa Memorial", city: "Odessa", state: "WA", lat: 47.3334, lng: -118.6876, beds: 25 },
            { name: "Othello Community Hospital", city: "Othello", state: "WA", lat: 46.8262, lng: -119.1754, beds: 25 },
            { name: "Prosser Memorial", city: "Prosser", state: "WA", lat: 46.2068, lng: -119.7684, beds: 25 },
            { name: "Quincy Valley Medical", city: "Quincy", state: "WA", lat: 47.2343, lng: -119.8526, beds: 25 },
            { name: "Samaritan Hospital", city: "Moses Lake", state: "WA", lat: 47.1301, lng: -119.2781, beds: 50 },
            { name: "Three Rivers Hospital", city: "Brewster", state: "WA", lat: 48.0965, lng: -119.7826, beds: 20 },
            { name: "Whitman Hospital", city: "Colfax", state: "WA", lat: 46.8804, lng: -117.3645, beds: 25 },
            { name: "Benewah Community Hospital", city: "St. Maries", state: "ID", lat: 47.3143, lng: -116.5626, beds: 19 },
            { name: "Bonner General Hospital", city: "Sandpoint", state: "ID", lat: 48.2766, lng: -116.5533, beds: 25 },
            { name: "Boundary Community Hospital", city: "Bonners Ferry", state: "ID", lat: 48.6918, lng: -116.3165, beds: 10 },
            { name: "Clearwater Valley Hospital", city: "Orofino", state: "ID", lat: 46.4793, lng: -116.2551, beds: 23 },
            { name: "McCall Memorial Hospital", city: "McCall", state: "ID", lat: 44.9110, lng: -116.1118, beds: 15 },
            { name: "Shoshone Medical Center", city: "Kellogg", state: "ID", lat: 47.5276, lng: -116.1201, beds: 25 },
            { name: "St. Mary's Hospital", city: "Cottonwood", state: "ID", lat: 46.0490, lng: -116.3482, beds: 25 },
            { name: "Syringa Hospital", city: "Grangeville", state: "ID", lat: 45.9265, lng: -116.1220, beds: 16 },
            { name: "Steele Memorial Medical", city: "Salmon", state: "ID", lat: 45.1757, lng: -113.8951, beds: 18 },
            { name: "Cabinet Peaks Medical", city: "Libby", state: "MT", lat: 48.3882, lng: -115.5556, beds: 25 },
            { name: "Clark Fork Valley Hospital", city: "Plains", state: "MT", lat: 47.4576, lng: -114.8826, beds: 25 },
            { name: "Community Memorial Hospital", city: "Hamilton", state: "MT", lat: 46.2465, lng: -114.1593, beds: 25 },
            { name: "St. Luke Community", city: "Ronan", state: "MT", lat: 47.5290, lng: -114.1001, beds: 25 },
            { name: "North Valley Hospital", city: "Whitefish", state: "MT", lat: 48.4111, lng: -114.3376, beds: 25 },
            { name: "Granite County Medical", city: "Philipsburg", state: "MT", lat: 46.3315, lng: -113.2915, beds: 10 },
            { name: "Powell County Memorial", city: "Deer Lodge", state: "MT", lat: 46.3990, lng: -112.7340, beds: 8 },
            { name: "Marcus Daly Memorial", city: "Hamilton", state: "MT", lat: 46.2465, lng: -114.1593, beds: 47 },
        ];

        const tribalHealthFacilities = [
            { name: "Native Health of Spokane", city: "Spokane", state: "WA", lat: 47.6588, lng: -117.4260, type: "Urban", tribe: "Multi-tribal" },
            { name: "Spokane Tribal Health", city: "Wellpinit", state: "WA", lat: 47.8890, lng: -117.9426, type: "Tribal", tribe: "Spokane Tribe" },
            { name: "Kalispel Tribal Health", city: "Usk", state: "WA", lat: 48.2926, lng: -117.2876, type: "Tribal", tribe: "Kalispel" },
            { name: "Colville Tribal Health", city: "Nespelem", state: "WA", lat: 48.1653, lng: -118.9814, type: "Tribal", tribe: "Colville Tribes" },
            { name: "Nimiipuu Health Kamiah", city: "Kamiah", state: "ID", lat: 46.2265, lng: -116.0293, type: "Tribal", tribe: "Nez Perce" },
            { name: "Nimiipuu Health Lapwai", city: "Lapwai", state: "ID", lat: 46.4043, lng: -116.8043, type: "Tribal", tribe: "Nez Perce" },
            { name: "Marimn Health", city: "Plummer", state: "ID", lat: 47.3343, lng: -116.8876, type: "Tribal", tribe: "Coeur d'Alene" },
            { name: "Kootenai Tribe Health", city: "Bonners Ferry", state: "ID", lat: 48.6918, lng: -116.3165, type: "Tribal", tribe: "Kootenai" },
            { name: "Flathead Tribal Health", city: "St. Ignatius", state: "MT", lat: 47.3176, lng: -114.0976, type: "Tribal", tribe: "Salish-Kootenai" },
            { name: "Arlee Health Center", city: "Arlee", state: "MT", lat: 47.1726, lng: -114.0876, type: "Tribal", tribe: "CSKT" },
            { name: "Yakama Indian Health Center", city: "Toppenish", state: "WA", lat: 46.3793, lng: -120.3110, type: "Tribal", tribe: "Yakama Nation" },
        ];

        const lifeFlightBases = [
            { name: "Life Flight Spokane", city: "Spokane", state: "WA", lat: 47.6193, lng: -117.5337, type: "helicopter", coverage: "Eastern WA" },
            { name: "Life Flight Pullman", city: "Pullman", state: "WA", lat: 46.7432, lng: -117.1696, type: "helicopter", coverage: "Palouse Region" },
            { name: "Life Flight Moses Lake", city: "Moses Lake", state: "WA", lat: 47.2093, lng: -119.3201, type: "both", coverage: "Central WA" },
            { name: "Life Flight Walla Walla", city: "Walla Walla", state: "WA", lat: 46.0646, lng: -118.3430, type: "helicopter", coverage: "SE Washington" },
            { name: "Life Flight Brewster", city: "Brewster", state: "WA", lat: 48.0965, lng: -119.7826, type: "helicopter", coverage: "Okanogan County" },
            { name: "Life Flight Richland", city: "Richland", state: "WA", lat: 46.3057, lng: -119.3043, type: "both", coverage: "Tri-Cities" },
            { name: "Life Flight Sandpoint", city: "Sandpoint", state: "ID", lat: 48.2766, lng: -116.5533, type: "helicopter", coverage: "North Idaho" },
            { name: "Life Flight Lewiston", city: "Lewiston", state: "ID", lat: 46.3743, lng: -117.0151, type: "both", coverage: "Clearwater Region" },
            { name: "Life Flight Coeur d'Alene", city: "Coeur d'Alene", state: "ID", lat: 47.7732, lng: -116.7885, type: "helicopter", coverage: "North Idaho" },
            { name: "Life Flight Missoula", city: "Missoula", state: "MT", lat: 46.9165, lng: -114.0879, type: "both", coverage: "Western Montana" },
        ];

        // ===== UTILITY FUNCTIONS =====

        function haversineDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function kmToMiles(km) {
            return (km / 1.60934).toFixed(1);
        }

        function getCertificationColor(certification) {
            const colors = {
                'CSC': '#9333ea',
                'TSC': '#0077C8',
                'PSC': '#10b981',
            };
            return colors[certification] || '#6b7280';
        }

        function createHospitalPopup(hospital, distance = null) {
            let html = `<div class="popup-title">${hospital.name}</div>`;
            html += `<div class="popup-info">${hospital.city}, ${hospital.state}</div>`;
            if (distance !== null) {
                html += `<div class="popup-info"><strong>${distance} miles</strong></div>`;
            }
            if (hospital.certification) {
                html += `<span class="popup-badge">${hospital.certification}</span>`;
            }
            return html;
        }

        function createFacilityPopup(facility, type) {
            let html = `<div class="popup-title">${facility.name}</div>`;
            html += `<div class="popup-info">${facility.city}, ${facility.state}</div>`;
            if (facility.beds) {
                html += `<div class="popup-info">Beds: ${facility.beds}</div>`;
            }
            if (facility.coverage) {
                html += `<div class="popup-info">Coverage: ${facility.coverage}</div>`;
            }
            if (facility.tribe) {
                html += `<div class="popup-info">Tribe: ${facility.tribe}</div>`;
            }
            return html;
        }

        function getStrokeRiskLevel(rate) {
            if (rate > 120) return "Very High";
            if (rate >= 80) return "High";
            if (rate >= 60) return "Moderate";
            return "Low";
        }

        function getStrokeRiskColor(rate) {
            if (rate > 120) return "#EB1700";
            if (rate >= 80) return "#F97316";
            if (rate >= 60) return "#0077C8";
            return "#002B5C";
        }

        function createCountyPopup(county) {
            const riskLevel = getStrokeRiskLevel(county.strokeDeathRate);
            const riskColor = getStrokeRiskColor(county.strokeDeathRate);

            let html = `<div class="county-popup-card">`;
            html += `<div class="county-card-header">${county.name}, ${county.state}</div>`;
            html += `<div class="county-card-row">
                        <span class="county-card-label">Population:</span>
                        <span class="county-card-value">${county.pop.toLocaleString()}</span>
                     </div>`;
            html += `<div class="county-card-row">
                        <span class="county-card-label">Stroke Deaths:</span>
                        <span class="county-card-value">${county.strokeDeaths} (${county.strokeDeathRate}/100K)</span>
                     </div>`;
            html += `<div class="county-card-row">
                        <span class="county-card-label">Avg Age:</span>
                        <span class="county-card-value">${county.avgAge}</span>
                     </div>`;
            html += `<div class="county-card-row">
                        <span class="county-card-label">Distance:</span>
                        <span class="county-card-value">${county.distMiles} mi from Spokane</span>
                     </div>`;
            html += `<div class="county-card-row">
                        <span class="county-card-label">EMS Service:</span>
                        <span class="county-card-value" style="font-size: 10px;">${county.ems}</span>
                     </div>`;
            html += `<div class="county-risk-badge" style="background-color: ${riskColor};">Risk Level: ${riskLevel}</div>`;
            html += `</div>`;
            return html;
        }

        // ===== MAP INITIALIZATION =====

        const map = L.map('map').setView([47.6588, -117.4260], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19,
        }).addTo(map);

        // ===== CHOROPLETH LAYER MANAGEMENT =====

        let choroplethGroup = L.layerGroup();
        let choroplethActive = false;
        let countyPolygons = [];

        function initializeChoropleth() {
            countyData.forEach(county => {
                const color = getStrokeRiskColor(county.strokeDeathRate);
                const polygon = L.polygon(county.bounds, {
                    color: color,
                    weight: 1,
                    opacity: 1,
                    fillColor: color,
                    fillOpacity: 0.3,
                    className: 'county-polygon'
                });

                polygon.bindPopup(createCountyPopup(county));
                polygon.on('mouseover', function() {
                    this.setStyle({ fillOpacity: 0.5, weight: 2 });
                });
                polygon.on('mouseout', function() {
                    this.setStyle({ fillOpacity: 0.3, weight: 1 });
                });

                countyPolygons.push(polygon);
                choroplethGroup.addLayer(polygon);
            });
        }

        initializeChoropleth();

        // ===== CHOROPLETH TOGGLE CONTROL =====

        const ChoroplethControl = L.Control.extend({
            options: {
                position: 'topright'
            },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-control-choropleth');
                const button = L.DomUtil.create('button', 'choropleth-toggle-btn', container);
                button.innerHTML = '<span class="choropleth-toggle-indicator"></span> Stroke Risk Map';

                L.DomEvent.on(button, 'click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    toggleChoropleth(button);
                });

                return container;
            }
        });

        const choroplethControl = new ChoroplethControl();
        choroplethControl.addTo(map);

        function toggleChoropleth(button) {
            choroplethActive = !choroplethActive;

            if (choroplethActive) {
                choroplethGroup.addTo(map);
                button.classList.add('active');
                addChoroplethLegend();
                dimFacilityMarkers();
            } else {
                map.removeLayer(choroplethGroup);
                button.classList.remove('active');
                removeChoroplethLegend();
                restoreFacilityMarkers();
            }
        }

        let choroplethLegendControl = null;

        function addChoroplethLegend() {
            if (choroplethLegendControl) return;

            const ChoroplethLegendControl = L.Control.extend({
                options: { position: 'bottomleft' },
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'choropleth-map-legend');
                    container.innerHTML = `
                        <div class="choropleth-map-legend-title">Stroke Mortality Rate</div>
                        <div class="choropleth-map-legend-tier">
                            <div class="choropleth-map-legend-color" style="background: #EB1700;"></div>
                            <span>Very High (&gt;120/100K)</span>
                        </div>
                        <div class="choropleth-map-legend-tier">
                            <div class="choropleth-map-legend-color" style="background: #F97316;"></div>
                            <span>High (80–120/100K)</span>
                        </div>
                        <div class="choropleth-map-legend-tier">
                            <div class="choropleth-map-legend-color" style="background: #0077C8;"></div>
                            <span>Moderate (60–80/100K)</span>
                        </div>
                        <div class="choropleth-map-legend-tier">
                            <div class="choropleth-map-legend-color" style="background: #002B5C;"></div>
                            <span>Low (&lt;60/100K)</span>
                        </div>
                    `;
                    return container;
                }
            });

            choroplethLegendControl = new ChoroplethLegendControl();
            choroplethLegendControl.addTo(map);
        }

        function removeChoroplethLegend() {
            if (choroplethLegendControl) {
                map.removeControl(choroplethLegendControl);
                choroplethLegendControl = null;
            }
        }

        let facilityMarkers = [];

        function dimFacilityMarkers() {
            map.eachLayer(function(layer) {
                if (layer instanceof L.CircleMarker && layer !== sacredHeartMarker) {
                    layer.setStyle({ opacity: 0.5, fillOpacity: 0.4 });
                }
            });
        }

        function restoreFacilityMarkers() {
            map.eachLayer(function(layer) {
                if (layer instanceof L.CircleMarker && layer !== sacredHeartMarker) {
                    layer.setStyle({ opacity: 1, fillOpacity: 0.8 });
                }
            });
        }

        // ===== DRAW RADII =====

        L.circle([sacredHeart.lat, sacredHeart.lng], {
            radius: 100 * 1.60934 * 1000,
            fillColor: '#3B82F6',
            color: '#0077C8',
            weight: 2,
            opacity: 0.3,
            fillOpacity: 0.1,
            className: 'radius-100-circle'
        }).addTo(map);

        L.circle([sacredHeart.lat, sacredHeart.lng], {
            radius: 200 * 1.60934 * 1000,
            fillColor: '#dbeafe',
            color: '#93c5fd',
            weight: 2,
            opacity: 0.4,
            fillOpacity: 0.05,
            dashArray: '5, 5',
            className: 'radius-200-circle'
        }).addTo(map);

        // ===== ADD SACRED HEART MARKER =====

        const sacredHeartMarker = L.circleMarker([sacredHeart.lat, sacredHeart.lng], {
            radius: 14,
            fillColor: '#EB1700',
            color: '#ffffff',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.95,
            className: 'sacred-heart-pulse'
        }).addTo(map);

        sacredHeartMarker.bindPopup(createHospitalPopup(sacredHeart, 0));
        sacredHeartMarker.on('click', function() {
            this.openPopup();
        });

        // ===== ADD EMS ROUTES =====

        emsRoutes.forEach(route => {
            L.polyline(route.coords, {
                color: route.color,
                weight: 3,
                opacity: 0.7,
                dashArray: '5, 5'
            }).addTo(map).bindPopup(`<div class="popup-title">${route.name}</div><div class="popup-info">Avg time: ${route.avgTime} min</div>`);
        });

        // ===== PROCESS AND ADD HOSPITALS =====

        const filteredHospitals = [];
        const hospitalsByZone = { zone1: [], zone2: [] };

        hospitals.forEach(hospital => {
            const distance = haversineDistance(sacredHeart.lat, sacredHeart.lng, hospital.lat, hospital.lng);
            const distanceMiles = kmToMiles(distance);

            if (distance <= 321.868) {
                filteredHospitals.push({ ...hospital, distance, distanceMiles });

                const color = getCertificationColor(hospital.certification);
                const marker = L.circleMarker([hospital.lat, hospital.lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindPopup(createHospitalPopup(hospital, distanceMiles));

                if (distance <= 160.934) {
                    hospitalsByZone.zone1.push({ ...hospital, distanceMiles });
                } else {
                    hospitalsByZone.zone2.push({ ...hospital, distanceMiles });
                }
            }
        });

        // ===== PROCESS AND ADD SPOKE HOSPITALS =====

        spokeHospitals.forEach(spoke => {
            const color = '#f97316';
            const marker = L.circleMarker([spoke.lat, spoke.lng], {
                radius: 8,
                fillColor: color,
                color: '#ffffff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            let popupHtml = `<div class="popup-title">${spoke.name}</div>`;
            popupHtml += `<div class="popup-info">${spoke.city}, ${spoke.state}</div>`;
            popupHtml += `<div class="popup-info">Annual Transfers: ${spoke.annualTransfers}</div>`;
            popupHtml += `<div class="popup-info">Avg Transfer Time: ${spoke.avgTransferTime} min</div>`;

            marker.bindPopup(popupHtml);

            L.polyline([[spoke.lat, spoke.lng], [sacredHeart.lat, sacredHeart.lng]], {
                color: '#f97316',
                weight: 2,
                opacity: 0.5,
                dashArray: '3, 3'
            }).addTo(map);
        });

        // ===== PROCESS AND ADD CRITICAL ACCESS HOSPITALS =====

        const cahsByZone = { zone1: [], zone2: [] };

        criticalAccessHospitals.forEach(cah => {
            const distance = haversineDistance(sacredHeart.lat, sacredHeart.lng, cah.lat, cah.lng);
            const distanceMiles = kmToMiles(distance);

            if (distance <= 321.868) {
                const marker = L.circleMarker([cah.lat, cah.lng], {
                    radius: 6,
                    fillColor: 'transparent',
                    color: '#ef4444',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0
                }).addTo(map);

                marker.bindPopup(createFacilityPopup(cah, 'CAH'));

                if (distance <= 160.934) {
                    cahsByZone.zone1.push({ ...cah, distanceMiles });
                } else {
                    cahsByZone.zone2.push({ ...cah, distanceMiles });
                }
            }
        });

        // ===== PROCESS AND ADD TRIBAL FACILITIES =====

        tribalHealthFacilities.forEach(tribal => {
            const distance = haversineDistance(sacredHeart.lat, sacredHeart.lng, tribal.lat, tribal.lng);

            if (distance <= 321.868) {
                const marker = L.circleMarker([tribal.lat, tribal.lng], {
                    radius: 7,
                    fillColor: '#06b6d4',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindPopup(createFacilityPopup(tribal, 'Tribal'));
            }
        });

        // ===== PROCESS AND ADD LIFE FLIGHT BASES =====

        lifeFlightBases.forEach(base => {
            const distance = haversineDistance(sacredHeart.lat, sacredHeart.lng, base.lat, base.lng);

            if (distance <= 321.868) {
                const marker = L.circleMarker([base.lat, base.lng], {
                    radius: 7,
                    fillColor: '#f59e0b',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindPopup(createFacilityPopup(base, 'Life Flight'));
            }
        });

        // ===== UPDATE STATS =====

        function updateStats() {
            const zone1Count = hospitalsByZone.zone1.length + cahsByZone.zone1.length;
            const zone2Count = hospitalsByZone.zone2.length + cahsByZone.zone2.length;
            const totalCount = zone1Count + zone2Count;

            document.getElementById('stat-zone1').textContent = zone1Count;
            document.getElementById('stat-zone2').textContent = zone2Count;
            document.getElementById('stat-total').textContent = totalCount;
        }

        updateStats();

        // ===== BUILD FACILITY LIST =====

        function buildFacilityList() {
            const facilityList = document.getElementById('facilityList');
            facilityList.innerHTML = '';

            const zone1Html = `
                <div class="facility-zone">
                    <div class="zone-header" onclick="toggleZone(this)">
                        <span class="zone-header-title">0–100 Miles</span>
                        <span class="zone-count">${hospitalsByZone.zone1.length + cahsByZone.zone1.length}</span>
                        <span class="zone-toggle open">▼</span>
                    </div>
                    <div class="zone-content open">
                        ${hospitalsByZone.zone1.map(h => `
                            <div class="facility-item" onclick="highlightMarker(${h.lat}, ${h.lng})">
                                <div class="facility-name">${h.name}</div>
                                <div class="facility-meta">
                                    <span>${h.city}, ${h.state}</span>
                                    <span class="facility-badge">${h.distanceMiles} mi</span>
                                </div>
                            </div>
                        `).join('')}
                        ${cahsByZone.zone1.map(c => `
                            <div class="facility-item" onclick="highlightMarker(${c.lat}, ${c.lng})">
                                <div class="facility-name">${c.name}</div>
                                <div class="facility-meta">
                                    <span>${c.city}, ${c.state}</span>
                                    <span class="facility-badge">${c.distanceMiles} mi</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            facilityList.innerHTML += zone1Html;

            const zone2Html = `
                <div class="facility-zone">
                    <div class="zone-header" onclick="toggleZone(this)">
                        <span class="zone-header-title">100–200 Miles</span>
                        <span class="zone-count">${hospitalsByZone.zone2.length + cahsByZone.zone2.length}</span>
                        <span class="zone-toggle">▼</span>
                    </div>
                    <div class="zone-content">
                        ${hospitalsByZone.zone2.map(h => `
                            <div class="facility-item" onclick="highlightMarker(${h.lat}, ${h.lng})">
                                <div class="facility-name">${h.name}</div>
                                <div class="facility-meta">
                                    <span>${h.city}, ${h.state}</span>
                                    <span class="facility-badge">${h.distanceMiles} mi</span>
                                </div>
                            </div>
                        `).join('')}
                        ${cahsByZone.zone2.map(c => `
                            <div class="facility-item" onclick="highlightMarker(${c.lat}, ${c.lng})">
                                <div class="facility-name">${c.name}</div>
                                <div class="facility-meta">
                                    <span>${c.city}, ${c.state}</span>
                                    <span class="facility-badge">${c.distanceMiles} mi</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            facilityList.innerHTML += zone2Html;
        }

        buildFacilityList();

        // ===== INTERACTIVE FUNCTIONS =====

        function toggleZone(element) {
            const toggle = element.querySelector('.zone-toggle');
            const content = element.nextElementSibling;

            toggle.classList.toggle('open');
            content.classList.toggle('open');
        }

        function highlightMarker(lat, lng) {
            map.setView([lat, lng], 9);
        }

        // ===== SIDEBAR TOGGLE (MOBILE) =====

        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });
        }

        // ===== SET DATE =====

        const today = new Date();
        const dateStr = today.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        document.getElementById('generatedDate').textContent = dateStr;
    </script>
</body>
</html>
