<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Providence Sacred Heart Medical Center — Outreach Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #002B5C 0%, #1a4d8a 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            z-index: 100;
        }

        .header-left {
            flex: 1;
            min-width: 300px;
        }

        .header-title {
            font-family: 'Poppins', sans-serif;
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 4px 0;
            color: #ffffff;
        }

        .header-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin: 0;
        }

        .header-branding {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            opacity: 0.85;
            white-space: nowrap;
        }

        .jnj-badge {
            background: rgba(235, 23, 0, 0.2);
            border: 1px solid #EB1700;
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: 600;
            color: #FFB3A7;
        }

        .header-right {
            font-size: 12px;
            opacity: 0.9;
            white-space: nowrap;
        }

        /* Main Container */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
            z-index: 50;
        }

        .sidebar-toggle {
            display: none;
            position: absolute;
            left: 12px;
            top: 100px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            z-index: 60;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-toggle:hover {
            background: #f3f4f6;
        }

        /* Stats Card */
        .stats-card {
            background: linear-gradient(135deg, #0077C8 0%, #0056a0 100%);
            border-radius: 8px;
            padding: 16px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0, 119, 200, 0.15);
        }

        .stats-card h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            opacity: 0.95;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .stat-value {
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        /* Section Headers */
        .section-title {
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #1f2937;
            margin-bottom: 12px;
            margin-top: 20px;
            letter-spacing: 0.5px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* Layer Toggles */
        .layer-toggle-group {
            margin-bottom: 20px;
        }

        .layer-toggle-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .layer-toggle-item:hover {
            background: #f3f4f6;
        }

        .layer-toggle-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #EB1700;
        }

        .layer-toggle-label {
            font-size: 12px;
            color: #374151;
            cursor: pointer;
            flex: 1;
        }

        /* Legend */
        .legend-section {
            margin-bottom: 24px;
        }

        .legend-title {
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #1f2937;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
            margin-bottom: 10px;
            padding: 4px 0;
        }

        .legend-marker {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
        }

        .legend-marker.sacred-heart {
            background: #EB1700;
            box-shadow: 0 0 0 2px rgba(235, 23, 0, 0.2);
        }

        .legend-marker.csc {
            background: #9333ea;
        }

        .legend-marker.tsc {
            background: #0077C8;
        }

        .legend-marker.psc {
            background: #10b981;
        }

        .legend-marker.spoke {
            background: #f97316;
        }

        .legend-marker.cah {
            border: 2px solid #ef4444;
            background: transparent;
        }

        .legend-marker.tribal {
            background: #06b6d4;
        }

        .legend-marker.lifeflight {
            background: #f59e0b;
        }

        .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 2px;
            border: 1px solid rgba(0, 0, 0, 0.15);
        }

        .legend-line {
            height: 2px;
            flex: 1;
            border-radius: 1px;
            background: #3B82F6;
        }

        .legend-circle {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .legend-circle.radius-100 {
            border: 2px solid #3B82F6;
            background: rgba(59, 130, 246, 0.1);
        }

        .legend-circle.radius-200 {
            border: 2px dashed #93c5fd;
            background: transparent;
        }

        /* Choropleth Legend */
        .choropleth-legend-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }

        .choropleth-legend-title {
            font-family: 'Poppins', sans-serif;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #1f2937;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .choropleth-tier {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            margin-bottom: 6px;
        }

        .choropleth-tier:last-child {
            margin-bottom: 0;
        }

        .choropleth-note {
            font-size: 9px;
            color: #6b7280;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #d1d5db;
            font-style: italic;
        }

        /* Data Sources Section */
        .data-sources-section {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .sources-header {
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #1f2937;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sources-toggle {
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .sources-toggle.open {
            transform: rotate(180deg);
        }

        .sources-list {
            display: none;
            font-size: 10px;
            color: #6b7280;
            line-height: 1.6;
        }

        .sources-list.open {
            display: block;
        }

        .sources-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sources-list li {
            margin-bottom: 6px;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: #e5e7eb;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Leaflet Overrides */
        .leaflet-popup-content {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            line-height: 1.5;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* County Popup Card */
        .county-popup-card {
            background: white;
            border-radius: 8px;
            padding: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-family: 'Inter', sans-serif;
            min-width: 220px;
        }

        .county-card-header {
            font-weight: 700;
            color: #1f2937;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .county-card-subheader {
            color: #6b7280;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .county-card-rate-label {
            color: #9ca3af;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .county-card-rate-value {
            font-weight: 600;
            font-size: 22px;
            margin-bottom: 8px;
        }

        .county-card-rate-unit {
            font-size: 11px;
            font-weight: 400;
        }

        .county-card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .county-card-grid-item {
            flex: 1;
        }

        .county-card-grid-label {
            color: #9ca3af;
            font-size: 10px;
            margin-bottom: 2px;
        }

        .county-card-grid-value {
            font-weight: 600;
            font-size: 12px;
            color: #1f2937;
        }

        .county-card-ems {
            margin-top: 6px;
        }

        .county-card-ems-label {
            color: #9ca3af;
            font-size: 10px;
            margin-bottom: 2px;
        }

        .county-card-ems-value {
            font-size: 11px;
            color: #1f2937;
        }

        .county-card-footer {
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px solid #e5e7eb;
            font-size: 9px;
            color: #9ca3af;
        }

        .popup-title {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .popup-info {
            color: #4b5563;
            margin: 4px 0;
            font-size: 11px;
        }

        /* Footer */
        .footer {
            background: #1f2937;
            color: #e5e7eb;
            padding: 12px 24px;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-top: 1px solid #374151;
        }

        .footer-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-left {
            flex: 1;
        }

        .footer-right {
            text-align: right;
            opacity: 0.8;
        }

        .footer-sources {
            font-size: 10px;
            opacity: 0.75;
            line-height: 1.4;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }

            .header-title {
                font-size: 18px;
            }

            .header-subtitle {
                font-size: 12px;
            }

            .header-right {
                display: none;
            }

            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                position: relative;
            }

            .sidebar.collapsed {
                max-height: 50px;
            }

            .sidebar-toggle {
                display: block;
            }

            .sidebar-content {
                display: none;
            }

            .sidebar.open .sidebar-content {
                display: block;
            }

            #map {
                min-height: 300px;
            }

            .footer {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .footer-line {
                flex-direction: column;
                gap: 4px;
            }
        }

        /* Print Styles */
        @media print {
            .header, .footer, .sidebar-toggle {
                display: none;
            }

            .container {
                height: auto;
            }

            .sidebar {
                display: none;
            }

            .map-container {
                height: 600px;
            }

            body {
                background: white;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(235, 23, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(235, 23, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(235, 23, 0, 0);
            }
        }

        .sacred-heart-pulse {
            animation: pulse 2s infinite;
        }

        /* Scrollbar Styling */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1 class="header-title">Providence Sacred Heart Medical Center — Outreach Map</h1>
            <p class="header-subtitle">Spokane, WA | Comprehensive Stroke Center | 100 & 200 Mile Service Radii</p>
        </div>
        <div class="header-branding">
            <span class="jnj-badge">J&J MedTech</span>
        </div>
        <div class="header-right">Prepared for Dr. Yiping Li</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebarToggle">☰</button>

            <div class="sidebar-content">
                <!-- Stats Card -->
                <div class="stats-card">
                    <h3>SERVICE AREA SUMMARY</h3>
                    <div class="stat-row">
                        <span>0–100 miles:</span>
                        <span class="stat-value" id="stat-zone1">–</span>
                    </div>
                    <div class="stat-row">
                        <span>100–200 miles:</span>
                        <span class="stat-value" id="stat-zone2">–</span>
                    </div>
                    <div class="stat-row">
                        <span>Total in radius:</span>
                        <span class="stat-value" id="stat-total">–</span>
                    </div>
                </div>

                <!-- Layer Toggles -->
                <div class="section-title">Map Layers</div>
                <div class="layer-toggle-group">
                    <label class="layer-toggle-item">
                        <input type="checkbox" id="toggle-choropleth" checked>
                        <span class="layer-toggle-label">Stroke Mortality</span>
                    </label>
                    <label class="layer-toggle-item">
                        <input type="checkbox" id="toggle-hospitals" checked>
                        <span class="layer-toggle-label">Hospitals</span>
                    </label>
                    <label class="layer-toggle-item">
                        <input type="checkbox" id="toggle-cah">
                        <span class="layer-toggle-label">Critical Access Hospitals</span>
                    </label>
                    <label class="layer-toggle-item">
                        <input type="checkbox" id="toggle-tribal">
                        <span class="layer-toggle-label">Tribal Health</span>
                    </label>
                    <label class="layer-toggle-item">
                        <input type="checkbox" id="toggle-lifeflight">
                        <span class="layer-toggle-label">Life Flight Bases</span>
                    </label>
                    <label class="layer-toggle-item">
                        <input type="checkbox" id="toggle-ems" checked>
                        <span class="layer-toggle-label">EMS Routes</span>
                    </label>
                    <label class="layer-toggle-item">
                        <input type="checkbox" id="toggle-spoke" checked>
                        <span class="layer-toggle-label">Spoke Hospitals</span>
                    </label>
                    <label class="layer-toggle-item">
                        <input type="checkbox" id="toggle-radius" checked>
                        <span class="layer-toggle-label">Radius Circles</span>
                    </label>
                </div>

                <!-- Legend -->
                <div class="section-title">Legend</div>
                <div class="legend-section">
                    <div class="legend-item">
                        <div class="legend-marker sacred-heart"></div>
                        <span>Sacred Heart Hub</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker csc"></div>
                        <span>Comprehensive Stroke Center</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker tsc"></div>
                        <span>Thrombectomy-Capable Center</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker psc"></div>
                        <span>Primary Stroke Center</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker spoke"></div>
                        <span>Spoke Referral Hospital</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker cah"></div>
                        <span>Critical Access Hospital</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker tribal"></div>
                        <span>Tribal Health Facility</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-marker lifeflight"></div>
                        <span>Life Flight Base</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-line"></div>
                        <span>EMS Route</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-circle radius-100"></div>
                        <span>100-mile radius</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-circle radius-200"></div>
                        <span>200-mile radius</span>
                    </div>

                    <!-- Choropleth Legend Section -->
                    <div class="choropleth-legend-section">
                        <div class="choropleth-legend-title">Stroke Mortality Rate</div>
                        <div class="choropleth-tier">
                            <div class="legend-swatch" style="background: #DC2626;"></div>
                            <span>Very High (&gt;80/100K)</span>
                        </div>
                        <div class="choropleth-tier">
                            <div class="legend-swatch" style="background: #F97316;"></div>
                            <span>High (60–80/100K)</span>
                        </div>
                        <div class="choropleth-tier">
                            <div class="legend-swatch" style="background: #0091E9;"></div>
                            <span>Moderate (40–60/100K)</span>
                        </div>
                        <div class="choropleth-tier">
                            <div class="legend-swatch" style="background: #E9ECEF;"></div>
                            <span>Low (&lt;40/100K)</span>
                        </div>
                        <div class="choropleth-note">CDC WONDER 2018–2023 (I60–I69)</div>
                    </div>
                </div>

                <!-- Data Sources -->
                <div class="data-sources-section">
                    <div class="sources-header" onclick="toggleSources()">
                        <span>Data Sources</span>
                        <span class="sources-toggle" id="sourcesToggle">▼</span>
                    </div>
                    <div class="sources-list" id="sourcesList">
                        <ul>
                            <li>CDC WONDER (stroke mortality 2018–2023, ICD-10 I60–I69)</li>
                            <li>US Census ACS 2023 (population, median age)</li>
                            <li>WA DOH CHARS (hospital discharge data)</li>
                            <li>State EMS Licensing directories (WA, ID, MT)</li>
                            <li>Flex Monitoring Team (Critical Access Hospitals)</li>
                            <li>Indian Health Service (tribal health facilities)</li>
                            <li>Life Flight Network / LifeMed Alaska</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-line">
            <div class="footer-left">
                J&J MedTech | PNW Territory | Generated <span id="generatedDate"></span> | For internal use only
            </div>
            <div class="footer-right">
                Sources: CDC WONDER | Census ACS | WA DOH CHARS | State EMS Directories | Flex Monitoring | IHS
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ===== MORTALITY DATA (Keyed for GeoJSON lookup) =====

        const mortalityData = {
            // Washington Eastern
            "wa-spokane": { county: "Spokane", state: "WA", deathsTotal: 1872, deathsPerYear: 312, population: 539339, rate: 57.9, avgAge: 37.2, distMiles: 0, ems: "Spokane Co. EMS / AMR", color: "#0091E9", category: "Moderate" },
            "wa-lincoln": { county: "Lincoln", state: "WA", deathsTotal: 84, deathsPerYear: 14, population: 10987, rate: 127.4, avgAge: 45.8, distMiles: 38, ems: "Lincoln Co. Fire/EMS", color: "#DC2626", category: "Very High" },
            "wa-stevens": { county: "Stevens", state: "WA", deathsTotal: 252, deathsPerYear: 42, population: 46345, rate: 90.6, avgAge: 42.3, distMiles: 55, ems: "Stevens Co. EMS / LifeFlight", color: "#F97316", category: "High" },
            "wa-pendoreille": { county: "Pend Oreille", state: "WA", deathsTotal: 96, deathsPerYear: 16, population: 13724, rate: 116.6, avgAge: 46.1, distMiles: 60, ems: "Pend Oreille Co. Fire/EMS", color: "#DC2626", category: "Very High" },
            "wa-whitman": { county: "Whitman", state: "WA", deathsTotal: 132, deathsPerYear: 22, population: 50804, rate: 43.3, avgAge: 24.8, distMiles: 65, ems: "Whitman Co. Ambulance / WSU EMS", color: "#0091E9", category: "Moderate" },
            "wa-adams": { county: "Adams", state: "WA", deathsTotal: 108, deathsPerYear: 18, population: 20668, rate: 87.1, avgAge: 30.2, distMiles: 85, ems: "Adams Co. Ambulance", color: "#F97316", category: "High" },
            "wa-ferry": { county: "Ferry", state: "WA", deathsTotal: 60, deathsPerYear: 10, population: 7966, rate: 125.6, avgAge: 47.3, distMiles: 80, ems: "Ferry Co. EMS / LifeFlight", color: "#DC2626", category: "Very High" },
            "wa-grant": { county: "Grant", state: "WA", deathsTotal: 456, deathsPerYear: 76, population: 99123, rate: 76.7, avgAge: 33.1, distMiles: 110, ems: "Grant Co. Fire #5 / AMR", color: "#0091E9", category: "Moderate" },
            "wa-okanogan": { county: "Okanogan", state: "WA", deathsTotal: 288, deathsPerYear: 48, population: 42243, rate: 113.6, avgAge: 42.6, distMiles: 120, ems: "Okanogan Co. Ambulance / LifeFlight", color: "#DC2626", category: "Very High" },
            "wa-douglas": { county: "Douglas", state: "WA", deathsTotal: 192, deathsPerYear: 32, population: 43429, rate: 73.7, avgAge: 35.2, distMiles: 130, ems: "Douglas Co. Fire / LifeFlight", color: "#0091E9", category: "Moderate" },
            "wa-chelan": { county: "Chelan", state: "WA", deathsTotal: 336, deathsPerYear: 56, population: 80492, rate: 69.6, avgAge: 38.4, distMiles: 140, ems: "Chelan Co. Fire / LifeFlight", color: "#0091E9", category: "Moderate" },
            "wa-wallawalla": { county: "Walla Walla", state: "WA", deathsTotal: 312, deathsPerYear: 52, population: 62584, rate: 83.1, avgAge: 37.6, distMiles: 150, ems: "Walla Walla Fire / AMR", color: "#F97316", category: "High" },
            "wa-columbia": { county: "Columbia", state: "WA", deathsTotal: 36, deathsPerYear: 6, population: 4064, rate: 147.6, avgAge: 49.2, distMiles: 130, ems: "Columbia Co. Ambulance", color: "#DC2626", category: "Very High" },
            "wa-garfield": { county: "Garfield", state: "WA", deathsTotal: 24, deathsPerYear: 4, population: 2247, rate: 178.0, avgAge: 50.1, distMiles: 100, ems: "Garfield Co. Ambulance", color: "#DC2626", category: "Very High" },
            "wa-asotin": { county: "Asotin", state: "WA", deathsTotal: 144, deathsPerYear: 24, population: 22582, rate: 106.3, avgAge: 42.8, distMiles: 105, ems: "Asotin Co. Fire / AMR", color: "#F97316", category: "High" },
            "wa-franklin": { county: "Franklin", state: "WA", deathsTotal: 288, deathsPerYear: 48, population: 95222, rate: 50.4, avgAge: 28.8, distMiles: 140, ems: "Pasco Fire / AMR", color: "#0091E9", category: "Moderate" },
            "wa-benton": { county: "Benton", state: "WA", deathsTotal: 756, deathsPerYear: 126, population: 204390, rate: 61.6, avgAge: 35.6, distMiles: 145, ems: "Richland Fire / AMR / LifeFlight", color: "#0091E9", category: "Moderate" },
            "wa-kittitas": { county: "Kittitas", state: "WA", deathsTotal: 156, deathsPerYear: 26, population: 47500, rate: 54.7, avgAge: 29.8, distMiles: 160, ems: "Kittitas Co. Fire/EMS", color: "#0091E9", category: "Moderate" },
            "wa-yakima": { county: "Yakima", state: "WA", deathsTotal: 618, deathsPerYear: 103, population: 256728, rate: 40.1, avgAge: 31.2, distMiles: 175, ems: "Yakima Fire / AMR", color: "#E9ECEF", category: "Low" },
            // Idaho Northern
            "id-kootenai": { county: "Kootenai", state: "ID", deathsTotal: 648, deathsPerYear: 108, population: 171003, rate: 63.2, avgAge: 38.5, distMiles: 35, ems: "Kootenai Co. Fire/EMS / AMR", color: "#0091E9", category: "Moderate" },
            "id-bonner": { county: "Bonner", state: "ID", deathsTotal: 228, deathsPerYear: 38, population: 47110, rate: 80.7, avgAge: 43.2, distMiles: 80, ems: "Bonner Co. EMS / LifeFlight", color: "#F97316", category: "High" },
            "id-boundary": { county: "Boundary", state: "ID", deathsTotal: 84, deathsPerYear: 14, population: 12783, rate: 109.5, avgAge: 44.8, distMiles: 95, ems: "Boundary Co. Ambulance", color: "#DC2626", category: "Very High" },
            "id-shoshone": { county: "Shoshone", state: "ID", deathsTotal: 96, deathsPerYear: 16, population: 13177, rate: 121.4, avgAge: 44.1, distMiles: 70, ems: "Shoshone Co. Ambulance / LifeFlight", color: "#DC2626", category: "Very High" },
            "id-benewah": { county: "Benewah", state: "ID", deathsTotal: 72, deathsPerYear: 12, population: 9511, rate: 126.2, avgAge: 43.6, distMiles: 50, ems: "Benewah Co. Ambulance", color: "#DC2626", category: "Very High" },
            "id-latah": { county: "Latah", state: "ID", deathsTotal: 96, deathsPerYear: 16, population: 40862, rate: 39.2, avgAge: 25.6, distMiles: 80, ems: "Moscow VFD / Gritman Ambulance", color: "#E9ECEF", category: "Low" },
            "id-nezperce": { county: "Nez Perce", state: "ID", deathsTotal: 228, deathsPerYear: 38, population: 41880, rate: 90.7, avgAge: 39.8, distMiles: 100, ems: "Lewiston Fire / AMR", color: "#F97316", category: "High" },
            "id-clearwater": { county: "Clearwater", state: "ID", deathsTotal: 72, deathsPerYear: 12, population: 9080, rate: 132.2, avgAge: 47.2, distMiles: 95, ems: "Clearwater Co. Ambulance", color: "#DC2626", category: "Very High" },
            "id-idaho": { county: "Idaho", state: "ID", deathsTotal: 120, deathsPerYear: 20, population: 17198, rate: 116.3, avgAge: 45.3, distMiles: 120, ems: "Idaho Co. Ambulance / LifeFlight", color: "#DC2626", category: "Very High" },
            "id-lewis": { county: "Lewis", state: "ID", deathsTotal: 36, deathsPerYear: 6, population: 3972, rate: 151.1, avgAge: 44.6, distMiles: 110, ems: "Lewis Co. Ambulance", color: "#DC2626", category: "Very High" },
            // Montana Western
            "mt-mineral": { county: "Mineral", state: "MT", deathsTotal: 36, deathsPerYear: 6, population: 4397, rate: 136.5, avgAge: 49.8, distMiles: 130, ems: "Mineral Co. Ambulance", color: "#DC2626", category: "Very High" },
            "mt-sanders": { county: "Sanders", state: "MT", deathsTotal: 96, deathsPerYear: 16, population: 12281, rate: 130.3, avgAge: 50.2, distMiles: 150, ems: "Sanders Co. Ambulance / LifeFlight", color: "#DC2626", category: "Very High" },
            "mt-lincoln": { county: "Lincoln", state: "MT", deathsTotal: 132, deathsPerYear: 22, population: 19839, rate: 110.9, avgAge: 47.6, distMiles: 140, ems: "Lincoln Co. Ambulance / LifeFlight", color: "#DC2626", category: "Very High" },
            "mt-missoula": { county: "Missoula", state: "MT", deathsTotal: 372, deathsPerYear: 62, population: 119600, rate: 51.8, avgAge: 33.4, distMiles: 200, ems: "Missoula Fire / AMR / LifeFlight", color: "#0091E9", category: "Moderate" },
            "mt-ravalli": { county: "Ravalli", state: "MT", deathsTotal: 264, deathsPerYear: 44, population: 44174, rate: 99.6, avgAge: 46.3, distMiles: 195, ems: "Ravalli Co. Ambulance / LifeFlight", color: "#F97316", category: "High" },
            "mt-lake": { county: "Lake", state: "MT", deathsTotal: 168, deathsPerYear: 28, population: 31008, rate: 90.3, avgAge: 41.8, distMiles: 175, ems: "Lake Co. Ambulance / LifeFlight", color: "#F97316", category: "High" },
            "mt-flathead": { county: "Flathead", state: "MT", deathsTotal: 432, deathsPerYear: 72, population: 104357, rate: 69.0, avgAge: 40.1, distMiles: 180, ems: "Flathead Co. Ambulance / ALERT / LifeFlight", color: "#0091E9", category: "Moderate" },
            "mt-granite": { county: "Granite", state: "MT", deathsTotal: 24, deathsPerYear: 4, population: 3403, rate: 117.6, avgAge: 51.2, distMiles: 170, ems: "Granite Co. Ambulance", color: "#DC2626", category: "Very High" },
            "mt-powell": { county: "Powell", state: "MT", deathsTotal: 42, deathsPerYear: 7, population: 6890, rate: 101.6, avgAge: 44.5, distMiles: 185, ems: "Powell Co. Ambulance", color: "#F97316", category: "High" },
        };

        // ===== EMBEDDED FACILITY DATA =====

        const sacredHeart = {
            name: "PROVIDENCE SACRED HEART MEDICAL CENTER",
            city: "Spokane",
            state: "WA",
            lat: 47.6588,
            lng: -117.4260,
            certification: "CSC",
        };

        const hospitals = [
            { name: "PROVIDENCE SACRED HEART MEDICAL CENTER", city: "Spokane", state: "WA", lat: 47.6588, lng: -117.4260, certification: "CSC" },
            { name: "MULTICARE DEACONESS HOSPITAL", city: "Spokane", state: "WA", lat: 47.6401, lng: -117.4101, certification: "PSC" },
            { name: "KOOTENAI HEALTH", city: "Coeur d'Alene", state: "ID", lat: 47.6901, lng: -116.7801, certification: "TSC" },
            { name: "PROVIDENCE ST PATRICK HOSPITAL", city: "Missoula", state: "MT", lat: 46.8721, lng: -114.0135, certification: "TSC" },
            { name: "COMMUNITY MEDICAL CENTER", city: "Missoula", state: "MT", lat: 46.8722, lng: -114.0056, certification: "PSC" },
            { name: "ST JOSEPHS REGIONAL MEDICAL CENTER", city: "Lewiston", state: "ID", lat: 46.4189, lng: -117.0178, certification: "PSC" },
            { name: "KADLEC REGIONAL MEDICAL CENTER", city: "Richland", state: "WA", lat: 46.2856, lng: -119.2845, certification: "TSC" },
            { name: "CENTRAL WASHINGTON HOSPITAL", city: "Wenatchee", state: "WA", lat: 47.4235, lng: -120.3103, certification: "PSC" },
            { name: "YAKIMA VALLEY MEMORIAL HOSPITAL", city: "Yakima", state: "WA", lat: 46.6021, lng: -120.5059, certification: "PSC" },
            { name: "PEACEHEALTH ST JOSEPH MEDICAL CENTER", city: "Bellingham", state: "WA", lat: 48.7519, lng: -122.4787, certification: "TSC" },
            { name: "PROVIDENCE ST MARY MEDICAL CENTER", city: "Walla Walla", state: "WA", lat: 46.0646, lng: -118.3430, certification: "PSC" },
            { name: "LOGAN HEALTH", city: "Kalispell", state: "MT", lat: 48.1920, lng: -114.3168, certification: "TSC" },
            { name: "BENEFIS HEALTH SYSTEM", city: "Great Falls", state: "MT", lat: 47.5053, lng: -111.3008, certification: "TSC" },
            { name: "EASTERN IDAHO REGIONAL MEDICAL CENTER", city: "Idaho Falls", state: "ID", lat: 43.4895, lng: -112.0339, certification: "TSC" },
            { name: "BOZEMAN HEALTH DEACONESS HOSPITAL", city: "Bozeman", state: "MT", lat: 45.6803, lng: -111.0367, certification: "TSC" },
            { name: "ST LUKES BOISE MEDICAL CENTER", city: "Boise", state: "ID", lat: 43.6018, lng: -116.2054, certification: "CSC" },
            { name: "SAINT ALPHONSUS REGIONAL MEDICAL CENTER", city: "Boise", state: "ID", lat: 43.6186, lng: -116.2247, certification: "CSC" },
            { name: "ST PETERS HEALTH", city: "Helena", state: "MT", lat: 46.5927, lng: -112.0361, certification: "PSC" },
            { name: "BILLINGS CLINIC", city: "Billings", state: "MT", lat: 45.7849, lng: -108.5039, certification: "CSC" },
            { name: "PORTNEUF MEDICAL CENTER", city: "Pocatello", state: "ID", lat: 42.8713, lng: -112.4455, certification: "PSC" },
            { name: "ST LUKES MERIDIAN MEDICAL CENTER", city: "Meridian", state: "ID", lat: 43.6008, lng: -116.3915, certification: "TSC" },
            { name: "ST JAMES HEALTHCARE", city: "Butte", state: "MT", lat: 46.0038, lng: -112.5348, certification: "PSC" },
            { name: "ST LUKES MAGIC VALLEY", city: "Twin Falls", state: "ID", lat: 42.5558, lng: -114.4701, certification: "PSC" },
            { name: "SAINT VINCENT HEALTHCARE", city: "Billings", state: "MT", lat: 45.7801, lng: -108.5101, certification: "PSC" },
            { name: "WEST VALLEY MEDICAL CENTER", city: "Caldwell", state: "ID", lat: 43.6629, lng: -116.6874, certification: "PSC" },
        ];

        const spokeHospitals = [
            { name: "Pullman Regional", city: "Pullman", state: "WA", lat: 46.7324, lng: -117.1817, annualTransfers: 18, avgTransferTime: 85, strokeCenter: "ASRH", beds: 25 },
            { name: "Gritman Medical", city: "Moscow", state: "ID", lat: 46.7324, lng: -117.0028, annualTransfers: 14, avgTransferTime: 90, strokeCenter: "PSC", beds: 25 },
        ];

        const emsRoutes = [
            { name: "US-2 West", from: "Wenatchee", to: "Sacred Heart", color: "#3B82F6", coords: [[47.4235, -120.3103], [47.6588, -117.4260]], avgTime: 180, type: "ground" },
            { name: "I-90 East", from: "Moses Lake", to: "Sacred Heart", color: "#3B82F6", coords: [[47.1301, -119.2781], [47.6588, -117.4260]], avgTime: 120, type: "ground" },
        ];

        const criticalAccessHospitals = [
            { name: "Columbia Basin Hospital", city: "Ephrata", state: "WA", lat: 47.3176, lng: -119.5536, beds: 25 },
            { name: "Coulee Medical Center", city: "Grand Coulee", state: "WA", lat: 47.9418, lng: -119.0033, beds: 25 },
            { name: "Dayton General Hospital", city: "Dayton", state: "WA", lat: 46.3237, lng: -117.9726, beds: 25 },
            { name: "Garfield County Hospital", city: "Pomeroy", state: "WA", lat: 46.4713, lng: -117.6008, beds: 25 },
            { name: "Kittitas Valley Healthcare", city: "Ellensburg", state: "WA", lat: 46.9965, lng: -120.5478, beds: 25 },
            { name: "Lake Chelan Community Hospital", city: "Chelan", state: "WA", lat: 47.8407, lng: -120.0161, beds: 25 },
            { name: "Lincoln Hospital", city: "Davenport", state: "WA", lat: 47.6540, lng: -118.1498, beds: 25 },
            { name: "Mid-Valley Hospital", city: "Omak", state: "WA", lat: 48.4107, lng: -119.5276, beds: 30 },
            { name: "Newport Hospital", city: "Newport", state: "WA", lat: 48.1851, lng: -117.0428, beds: 24 },
            { name: "North Valley Hospital", city: "Tonasket", state: "WA", lat: 48.7054, lng: -119.4389, beds: 25 },
            { name: "Odessa Memorial", city: "Odessa", state: "WA", lat: 47.3334, lng: -118.6876, beds: 25 },
            { name: "Othello Community Hospital", city: "Othello", state: "WA", lat: 46.8262, lng: -119.1754, beds: 25 },
            { name: "Prosser Memorial", city: "Prosser", state: "WA", lat: 46.2068, lng: -119.7684, beds: 25 },
            { name: "Quincy Valley Medical", city: "Quincy", state: "WA", lat: 47.2343, lng: -119.8526, beds: 25 },
            { name: "Samaritan Hospital", city: "Moses Lake", state: "WA", lat: 47.1301, lng: -119.2781, beds: 50 },
            { name: "Three Rivers Hospital", city: "Brewster", state: "WA", lat: 48.0965, lng: -119.7826, beds: 20 },
            { name: "Whitman Hospital", city: "Colfax", state: "WA", lat: 46.8804, lng: -117.3645, beds: 25 },
            { name: "Benewah Community Hospital", city: "St. Maries", state: "ID", lat: 47.3143, lng: -116.5626, beds: 19 },
            { name: "Bonner General Hospital", city: "Sandpoint", state: "ID", lat: 48.2766, lng: -116.5533, beds: 25 },
            { name: "Boundary Community Hospital", city: "Bonners Ferry", state: "ID", lat: 48.6918, lng: -116.3165, beds: 10 },
            { name: "Clearwater Valley Hospital", city: "Orofino", state: "ID", lat: 46.4793, lng: -116.2551, beds: 23 },
            { name: "McCall Memorial Hospital", city: "McCall", state: "ID", lat: 44.9110, lng: -116.1118, beds: 15 },
            { name: "Shoshone Medical Center", city: "Kellogg", state: "ID", lat: 47.5276, lng: -116.1201, beds: 25 },
            { name: "St. Mary's Hospital", city: "Cottonwood", state: "ID", lat: 46.0490, lng: -116.3482, beds: 25 },
            { name: "Syringa Hospital", city: "Grangeville", state: "ID", lat: 45.9265, lng: -116.1220, beds: 16 },
            { name: "Steele Memorial Medical", city: "Salmon", state: "ID", lat: 45.1757, lng: -113.8951, beds: 18 },
            { name: "Cabinet Peaks Medical", city: "Libby", state: "MT", lat: 48.3882, lng: -115.5556, beds: 25 },
            { name: "Clark Fork Valley Hospital", city: "Plains", state: "MT", lat: 47.4576, lng: -114.8826, beds: 25 },
            { name: "Community Memorial Hospital", city: "Hamilton", state: "MT", lat: 46.2465, lng: -114.1593, beds: 25 },
            { name: "St. Luke Community", city: "Ronan", state: "MT", lat: 47.5290, lng: -114.1001, beds: 25 },
            { name: "North Valley Hospital", city: "Whitefish", state: "MT", lat: 48.4111, lng: -114.3376, beds: 25 },
            { name: "Granite County Medical", city: "Philipsburg", state: "MT", lat: 46.3315, lng: -113.2915, beds: 10 },
            { name: "Powell County Memorial", city: "Deer Lodge", state: "MT", lat: 46.3990, lng: -112.7340, beds: 8 },
            { name: "Marcus Daly Memorial", city: "Hamilton", state: "MT", lat: 46.2465, lng: -114.1593, beds: 47 },
        ];

        const tribalHealthFacilities = [
            { name: "Native Health of Spokane", city: "Spokane", state: "WA", lat: 47.6588, lng: -117.4260, type: "Urban", tribe: "Multi-tribal" },
            { name: "Spokane Tribal Health", city: "Wellpinit", state: "WA", lat: 47.8890, lng: -117.9426, type: "Tribal", tribe: "Spokane Tribe" },
            { name: "Kalispel Tribal Health", city: "Usk", state: "WA", lat: 48.2926, lng: -117.2876, type: "Tribal", tribe: "Kalispel" },
            { name: "Colville Tribal Health", city: "Nespelem", state: "WA", lat: 48.1653, lng: -118.9814, type: "Tribal", tribe: "Colville Tribes" },
            { name: "Nimiipuu Health Kamiah", city: "Kamiah", state: "ID", lat: 46.2265, lng: -116.0293, type: "Tribal", tribe: "Nez Perce" },
            { name: "Nimiipuu Health Lapwai", city: "Lapwai", state: "ID", lat: 46.4043, lng: -116.8043, type: "Tribal", tribe: "Nez Perce" },
            { name: "Marimn Health", city: "Plummer", state: "ID", lat: 47.3343, lng: -116.8876, type: "Tribal", tribe: "Coeur d'Alene" },
            { name: "Kootenai Tribe Health", city: "Bonners Ferry", state: "ID", lat: 48.6918, lng: -116.3165, type: "Tribal", tribe: "Kootenai" },
            { name: "Flathead Tribal Health", city: "St. Ignatius", state: "MT", lat: 47.3176, lng: -114.0976, type: "Tribal", tribe: "Salish-Kootenai" },
            { name: "Arlee Health Center", city: "Arlee", state: "MT", lat: 47.1726, lng: -114.0876, type: "Tribal", tribe: "CSKT" },
            { name: "Yakama Indian Health Center", city: "Toppenish", state: "WA", lat: 46.3793, lng: -120.3110, type: "Tribal", tribe: "Yakama Nation" },
        ];

        const lifeFlightBases = [
            { name: "Life Flight Spokane", city: "Spokane", state: "WA", lat: 47.6193, lng: -117.5337, type: "helicopter", coverage: "Eastern WA" },
            { name: "Life Flight Pullman", city: "Pullman", state: "WA", lat: 46.7432, lng: -117.1696, type: "helicopter", coverage: "Palouse Region" },
            { name: "Life Flight Moses Lake", city: "Moses Lake", state: "WA", lat: 47.2093, lng: -119.3201, type: "both", coverage: "Central WA" },
            { name: "Life Flight Walla Walla", city: "Walla Walla", state: "WA", lat: 46.0646, lng: -118.3430, type: "helicopter", coverage: "SE Washington" },
            { name: "Life Flight Brewster", city: "Brewster", state: "WA", lat: 48.0965, lng: -119.7826, type: "helicopter", coverage: "Okanogan County" },
            { name: "Life Flight Richland", city: "Richland", state: "WA", lat: 46.3057, lng: -119.3043, type: "both", coverage: "Tri-Cities" },
            { name: "Life Flight Sandpoint", city: "Sandpoint", state: "ID", lat: 48.2766, lng: -116.5533, type: "helicopter", coverage: "North Idaho" },
            { name: "Life Flight Lewiston", city: "Lewiston", state: "ID", lat: 46.3743, lng: -117.0151, type: "both", coverage: "Clearwater Region" },
            { name: "Life Flight Coeur d'Alene", city: "Coeur d'Alene", state: "ID", lat: 47.7732, lng: -116.7885, type: "helicopter", coverage: "North Idaho" },
            { name: "Life Flight Missoula", city: "Missoula", state: "MT", lat: 46.9165, lng: -114.0879, type: "both", coverage: "Western Montana" },
        ];

        // ===== UTILITY FUNCTIONS =====

        function haversineDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function kmToMiles(km) {
            return (km / 1.60934).toFixed(1);
        }

        function getCertificationColor(certification) {
            const colors = {
                'CSC': '#9333ea',
                'TSC': '#0077C8',
                'PSC': '#10b981',
            };
            return colors[certification] || '#6b7280';
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function createCountyPopup(mortalityEntry) {
            const rate = mortalityEntry.rate;
            const rateColor = rate > 80 ? "#DC2626" : rate >= 60 ? "#F97316" : rate >= 40 ? "#0091E9" : "#E9ECEF";

            let html = `<div class="county-popup-card">`;
            html += `<div class="county-card-header">${mortalityEntry.county} County</div>`;
            html += `<div class="county-card-subheader">${mortalityEntry.state}</div>`;
            html += `<div class="county-card-rate-label">Stroke Mortality Rate</div>`;
            html += `<div class="county-card-rate-value" style="color: ${rateColor};">${rate}<span class="county-card-rate-unit">per 100K</span></div>`;
            html += `<div class="county-card-grid">`;
            html += `<div class="county-card-grid-item">`;
            html += `<div class="county-card-grid-label">Deaths/Year</div>`;
            html += `<div class="county-card-grid-value">${mortalityEntry.deathsPerYear}</div>`;
            html += `</div>`;
            html += `<div class="county-card-grid-item">`;
            html += `<div class="county-card-grid-label">Population</div>`;
            html += `<div class="county-card-grid-value">${formatNumber(mortalityEntry.population)}</div>`;
            html += `</div>`;
            html += `<div class="county-card-grid-item">`;
            html += `<div class="county-card-grid-label">Avg Age</div>`;
            html += `<div class="county-card-grid-value">${mortalityEntry.avgAge}</div>`;
            html += `</div>`;
            html += `<div class="county-card-grid-item">`;
            html += `<div class="county-card-grid-label">Distance</div>`;
            html += `<div class="county-card-grid-value">${mortalityEntry.distMiles} mi</div>`;
            html += `</div>`;
            html += `</div>`;
            html += `<div class="county-card-ems">`;
            html += `<div class="county-card-ems-label">Ambulance Service</div>`;
            html += `<div class="county-card-ems-value">${mortalityEntry.ems}</div>`;
            html += `</div>`;
            html += `<div class="county-card-footer">CDC WONDER 2018–2023 (I60–I69)</div>`;
            html += `</div>`;
            return html;
        }

        function createHospitalPopup(hospital, distance = null) {
            let html = `<div class="popup-title">${hospital.name}</div>`;
            html += `<div class="popup-info">${hospital.city}, ${hospital.state}</div>`;
            if (distance !== null) {
                html += `<div class="popup-info"><strong>${distance} miles</strong></div>`;
            }
            if (hospital.certification) {
                html += `<div class="popup-info"><strong>${hospital.certification}</strong></div>`;
            }
            return html;
        }

        function createFacilityPopup(facility, type) {
            let html = `<div class="popup-title">${facility.name}</div>`;
            html += `<div class="popup-info">${facility.city}, ${facility.state}</div>`;
            if (facility.beds) {
                html += `<div class="popup-info">Beds: ${facility.beds}</div>`;
            }
            if (facility.coverage) {
                html += `<div class="popup-info">Coverage: ${facility.coverage}</div>`;
            }
            if (facility.tribe) {
                html += `<div class="popup-info">Tribe: ${facility.tribe}</div>`;
            }
            return html;
        }

        // ===== MAP INITIALIZATION =====

        const map = L.map('map').setView([47.6588, -117.4260], 7);

        // CARTO Light tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
            maxZoom: 19,
        }).addTo(map);

        // ===== LAYER GROUPS =====

        const choroplethlayerGroup = L.layerGroup();
        const hospitalsLayerGroup = L.layerGroup();
        const cahLayerGroup = L.layerGroup();
        const tribalLayerGroup = L.layerGroup();
        const lifeflightLayerGroup = L.layerGroup();
        const emsLayerGroup = L.layerGroup();
        const spokeLayerGroup = L.layerGroup();
        const radiusLayerGroup = L.layerGroup();

        // ===== RADIUS CIRCLES =====

        const radius100 = L.circle([sacredHeart.lat, sacredHeart.lng], {
            radius: 100 * 1.60934 * 1000,
            fillColor: '#3B82F6',
            color: '#0077C8',
            weight: 2,
            opacity: 0.3,
            fillOpacity: 0.1,
        });

        const radius200 = L.circle([sacredHeart.lat, sacredHeart.lng], {
            radius: 200 * 1.60934 * 1000,
            fillColor: '#dbeafe',
            color: '#93c5fd',
            weight: 2,
            opacity: 0.4,
            fillOpacity: 0.05,
            dashArray: '5, 5',
        });

        radiusLayerGroup.addLayer(radius100);
        radiusLayerGroup.addLayer(radius200);
        radiusLayerGroup.addTo(map);

        // ===== SACRED HEART MARKER =====

        const sacredHeartMarker = L.circleMarker([sacredHeart.lat, sacredHeart.lng], {
            radius: 14,
            fillColor: '#EB1700',
            color: '#ffffff',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.95,
            className: 'sacred-heart-pulse',
            zIndex: 1000,
        }).addTo(map);

        sacredHeartMarker.bindPopup(createHospitalPopup(sacredHeart, 0));

        // ===== LOAD GEOjSON AND CREATE CHOROPLETH =====

        fetch('pnw-counties.geojson')
            .then(response => response.json())
            .then(geojsonData => {
                L.geoJSON(geojsonData, {
                    style: function(feature) {
                        const props = feature.properties;
                        const key = `${props.STATE_ABBR.toLowerCase()}-${props.NAME.toLowerCase().replace(/[\s-]+/g, '')}`;
                        const data = mortalityData[key];

                        let fillColor = '#F3F4F6';
                        let opacity = 0.3;

                        if (data) {
                            fillColor = data.color;
                            opacity = 0.7;
                        }

                        return {
                            fillColor: fillColor,
                            weight: 1,
                            opacity: 0.8,
                            color: '#666',
                            fillOpacity: opacity,
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        const key = `${props.STATE_ABBR.toLowerCase()}-${props.NAME.toLowerCase().replace(/[\s-]+/g, '')}`;
                        const data = mortalityData[key];

                        if (data) {
                            layer.bindPopup(createCountyPopup(data));
                            layer.on('mouseover', function() {
                                this.setStyle({ fillOpacity: 0.85, weight: 2 });
                            });
                            layer.on('mouseout', function() {
                                this.setStyle({ fillOpacity: 0.7, weight: 1 });
                            });
                        } else {
                            layer.setStyle({ fillOpacity: 0.3 });
                            layer.on('mouseover', function() {
                                this.setStyle({ fillOpacity: 0.4, weight: 2 });
                            });
                            layer.on('mouseout', function() {
                                this.setStyle({ fillOpacity: 0.3, weight: 1 });
                            });
                        }
                    }
                }).addTo(choroplethlayerGroup);

                choroplethlayerGroup.addTo(map);
            })
            .catch(error => console.error('Error loading GeoJSON:', error));

        // ===== HOSPITALS =====

        const hospitalsByZone = { zone1: [], zone2: [] };

        hospitals.forEach(hospital => {
            const distance = haversineDistance(sacredHeart.lat, sacredHeart.lng, hospital.lat, hospital.lng);
            const distanceMiles = kmToMiles(distance);

            if (distance <= 321.868) {
                const color = getCertificationColor(hospital.certification);
                const marker = L.circleMarker([hospital.lat, hospital.lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8,
                }).addTo(hospitalsLayerGroup);

                marker.bindPopup(createHospitalPopup(hospital, distanceMiles));

                if (distance <= 160.934) {
                    hospitalsByZone.zone1.push({ ...hospital, distanceMiles });
                } else {
                    hospitalsByZone.zone2.push({ ...hospital, distanceMiles });
                }
            }
        });

        hospitalsLayerGroup.addTo(map);

        // ===== CRITICAL ACCESS HOSPITALS =====

        const cahsByZone = { zone1: [], zone2: [] };

        criticalAccessHospitals.forEach(cah => {
            const distance = haversineDistance(sacredHeart.lat, sacredHeart.lng, cah.lat, cah.lng);
            const distanceMiles = kmToMiles(distance);

            if (distance <= 321.868) {
                const marker = L.circleMarker([cah.lat, cah.lng], {
                    radius: 6,
                    fillColor: 'transparent',
                    color: '#ef4444',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0,
                }).addTo(cahLayerGroup);

                marker.bindPopup(createFacilityPopup(cah, 'CAH'));

                if (distance <= 160.934) {
                    cahsByZone.zone1.push({ ...cah, distanceMiles });
                } else {
                    cahsByZone.zone2.push({ ...cah, distanceMiles });
                }
            }
        });

        // ===== TRIBAL FACILITIES =====

        tribalHealthFacilities.forEach(tribal => {
            const distance = haversineDistance(sacredHeart.lat, sacredHeart.lng, tribal.lat, tribal.lng);

            if (distance <= 321.868) {
                const marker = L.circleMarker([tribal.lat, tribal.lng], {
                    radius: 7,
                    fillColor: '#06b6d4',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8,
                }).addTo(tribalLayerGroup);

                marker.bindPopup(createFacilityPopup(tribal, 'Tribal'));
            }
        });

        // ===== LIFE FLIGHT BASES =====

        lifeFlightBases.forEach(base => {
            const distance = haversineDistance(sacredHeart.lat, sacredHeart.lng, base.lat, base.lng);

            if (distance <= 321.868) {
                const marker = L.circleMarker([base.lat, base.lng], {
                    radius: 7,
                    fillColor: '#f59e0b',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8,
                }).addTo(lifeflightLayerGroup);

                marker.bindPopup(createFacilityPopup(base, 'Life Flight'));
            }
        });

        // ===== EMS ROUTES =====

        emsRoutes.forEach(route => {
            const polyline = L.polyline(route.coords, {
                color: route.color,
                weight: 3,
                opacity: 0.7,
                dashArray: '5, 5',
            }).addTo(emsLayerGroup);

            polyline.bindPopup(`<div class="popup-title">${route.name}</div><div class="popup-info">Avg time: ${route.avgTime} min</div>`);
        });

        emsLayerGroup.addTo(map);

        // ===== SPOKE HOSPITALS =====

        spokeHospitals.forEach(spoke => {
            const color = '#f97316';
            const marker = L.circleMarker([spoke.lat, spoke.lng], {
                radius: 8,
                fillColor: color,
                color: '#ffffff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8,
            }).addTo(spokeLayerGroup);

            let popupHtml = `<div class="popup-title">${spoke.name}</div>`;
            popupHtml += `<div class="popup-info">${spoke.city}, ${spoke.state}</div>`;
            popupHtml += `<div class="popup-info">Annual Transfers: ${spoke.annualTransfers}</div>`;
            popupHtml += `<div class="popup-info">Avg Transfer Time: ${spoke.avgTransferTime} min</div>`;

            marker.bindPopup(popupHtml);

            const line = L.polyline([[spoke.lat, spoke.lng], [sacredHeart.lat, sacredHeart.lng]], {
                color: '#f97316',
                weight: 2,
                opacity: 0.5,
                dashArray: '3, 3',
            }).addTo(spokeLayerGroup);
        });

        spokeLayerGroup.addTo(map);

        // ===== UPDATE STATS =====

        function updateStats() {
            const zone1Count = hospitalsByZone.zone1.length + cahsByZone.zone1.length;
            const zone2Count = hospitalsByZone.zone2.length + cahsByZone.zone2.length;
            const totalCount = zone1Count + zone2Count;

            document.getElementById('stat-zone1').textContent = zone1Count;
            document.getElementById('stat-zone2').textContent = zone2Count;
            document.getElementById('stat-total').textContent = totalCount;
        }

        updateStats();

        // ===== LAYER TOGGLE CONTROLS =====

        document.getElementById('toggle-choropleth').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(choroplethlayerGroup);
            } else {
                map.removeLayer(choroplethlayerGroup);
            }
        });

        document.getElementById('toggle-hospitals').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(hospitalsLayerGroup);
            } else {
                map.removeLayer(hospitalsLayerGroup);
            }
        });

        document.getElementById('toggle-cah').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(cahLayerGroup);
            } else {
                map.removeLayer(cahLayerGroup);
            }
        });

        document.getElementById('toggle-tribal').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(tribalLayerGroup);
            } else {
                map.removeLayer(tribalLayerGroup);
            }
        });

        document.getElementById('toggle-lifeflight').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(lifeflightLayerGroup);
            } else {
                map.removeLayer(lifeflightLayerGroup);
            }
        });

        document.getElementById('toggle-ems').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(emsLayerGroup);
            } else {
                map.removeLayer(emsLayerGroup);
            }
        });

        document.getElementById('toggle-spoke').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(spokeLayerGroup);
            } else {
                map.removeLayer(spokeLayerGroup);
            }
        });

        document.getElementById('toggle-radius').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(radiusLayerGroup);
            } else {
                map.removeLayer(radiusLayerGroup);
            }
        });

        // ===== SIDEBAR TOGGLE (MOBILE) =====

        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });
        }

        // ===== SOURCES TOGGLE =====

        function toggleSources() {
            const sourcesList = document.getElementById('sourcesList');
            const sourcesToggle = document.getElementById('sourcesToggle');
            sourcesList.classList.toggle('open');
            sourcesToggle.classList.toggle('open');
        }

        // ===== SET DATE =====

        const today = new Date();
        const dateStr = today.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        document.getElementById('generatedDate').textContent = dateStr;
    </script>
</body>
</html>
